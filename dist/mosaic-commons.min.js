/* 
 * mosaic-commons v0.0.9 | License: MIT 
 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b(require("underscore"),require("events"),require("when")):"function"==typeof define&&define.amd?define(["underscore","events","when"],b):"object"==typeof exports?exports["mosaic-commons"]=b(require("underscore"),require("events"),require("when")):a["mosaic-commons"]=b(a.underscore,a.events,a.when)}(this,function(a,b,c){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){var d=a.exports={};d.Class=c(1),d.Errors=c(2),d.Events=c(3),d.P=c(4)},function(a,b,c){function d(a){a=a||{},e.extend(this.instanceFields,a.instanceFields),e.extend(this.classFields,a.classFields)}var e=c(5),f="__type",g="__meta",h="__type_id",i="__parent";e.extend(d.prototype,{instanceFields:{instanceOf:function(a){var b=this.__getClass(),c=b.getMetaClass();return c.classFields.isSubtype.call(b,a,!0)},setOptions:function(a){this.options=e.extend({},this.options,a)},toString:function(){var a=this.__getClass();return a?a[h]+"":"undefined"},getClass:function(){return this.__getClass()},__getClass:function(){return this[f]}},classFields:{isSubtype:function(a,b){if(!a||!a[h])return!1;for(var c=!1,d=b?this:this[i];!c&&d&&void 0!==d[h];d=d[i])c=d[h]==a[h];return c},isSameType:function(a){return a&&a[h]?this[h]==a[h]:!1},hasInstance:function(a){return a&&a.instanceOf?a.instanceOf.call(a,this):!1},getMetaClass:function(){return this[g]},getParent:function(){return this[i]},extend:function(){var a=this.getMetaClass(),b=a.createClass(this,e.toArray(arguments));return b}},extendClassFields:function(a,b){e.extend(b,this.classFields),e.extend(b,a),b[g]=this,b[h]=e.uniqueId("type-"),b[i]=a},extendInstanceFields:function(a,b){var c=a[i];e.extend(a.prototype,this.instanceFields),c&&e.extend(a.prototype,c.prototype),e.each(b,function(b){e.extend(a.prototype,b)}),a.prototype[f]=a},newType:function(){function a(){this.initialize&&this.initialize.apply(this,arguments)}return a},createClass:function(a,b){var c=this.newType(a,b);return this.extendClassFields(a,c,b),this.extendInstanceFields(c,b),c}});var j=new d,k=j.createClass();k.MetaClass=d,a.exports=k},function(a,b,c){function d(){var a=d.newError;return a.apply(a,arguments)}function e(a){var b;return a instanceof Error?b=a:(i.isString(a)&&0===a.indexOf("Error: ")&&(a=a.substring("Error: ".length)),b=new Error(a)),i.extend(b,j),b}function f(a){var b=e(a.message);return i.isArray(a.trace)&&(b.stack=a.trace.join("\n")),a.code&&b.code(a.code),a.messageKey&&b.messageKey(a.messageKey),b}function g(a){var b={message:"ERROR"};return a&&(b.message=a+"",b.messageKey=a._messageKey,b.status=a.status||500,i.isArray(a.stack)?b.trace=h(a.stack):i.isString(a.stack)?b.trace=a.stack.split(/[\r\n]+/gim):i.isObject(a)?i.each(i.keys(a),function(c){b[c]=a[c]}):b.trace=[JSON.stringify(a)]),b}function h(a){return a?JSON.parse(JSON.stringify(a)):null}var i=c(5);i.extend(d,{newError:e,toJSON:g,fromJSON:f});var j={code:function(a){return void 0===a?this.status:(this.status=a,this)},messageKey:function(a){return void 0===a?this._messageKey:(this._messageKey=a,this)}};a.exports=d},function(a,b,c){var d=c(6),e=c(5),f=function(){d.EventEmitter.apply(this,arguments)};e.extend(f.prototype,d.EventEmitter.prototype,{fire:d.EventEmitter.prototype.emit}),e.extend(f,{listenTo:function(a,b,c,d){var e=this._listeners=this._listeners||[];d=d||this,a.on(b,c,d),e.push({obj:a,event:b,handler:c,context:d})},stopListening:function(a,b){a?this._listeners=e.filter(this._listeners,function(c){var d=!0,e=c.context||this;return c.obj==a&&(b&&b!=c.event||(c.obj.off(c.event,c.handler,e),d=!1)),d},this):(e.each(this._listeners,function(a){var b=a.context||this;a.obj.off(a.event,a.handler,b)},this),delete this._listeners)},triggerMethod:function(){function a(a,b,c){return c.toUpperCase()}var b=/(^|:)(\w)/gi,c=function(c){var d="on"+c.replace(b,a),f=this[d];return e.isFunction(this.fire)&&this.fire.apply(this,arguments),e.isFunction(f)?f.apply(this,e.tail(arguments)):void 0};return c}()}),a.exports=f},function(a,b,c){function d(a,b){return Array.prototype.slice.call(a,b)}function e(){return f.apply(this,arguments)}for(var f=c(7),g=["promise","resolve","reject","defer","join","all","spread"],h=0;h<g.length;h++)e[g[h]]=f[g[h]];e.promise=f.promise||function(){return new e},e.then=f.then||function(){var a=new e;return a.then.apply(a,arguments)},e.fin=function(a,b){return a.then(function(a){return e.then(function(){return b(null,a)}).then(function(){return a})},function(a){return e.then(function(){return b(a)}).then(function(){throw a})})},e.timeout=f.timeout?f.timeout:function(a,b){var c=e.defer(),d=setTimeout(function(){b=b||"Timed out after "+a+" ms",c.reject(new Error(b))},a);return c.promise.then(function(a){return clearTimeout(d),a},function(a){throw clearTimeout(d),a})},e.delay=f.delay||function(a){return a=a||0,e.then(function(b){var c=e.defer(),d=setTimeout(function(){c.resolve(b)},a);return c.promise.cancel=function(){clearTimeout(d),c.resolve(b)},c.promise})},e.nresolver=function(a){return function(b,c){b?a.reject(b):a.resolve(arguments.length>2?d(arguments,1):c)}},e.nwrapper=function(a,b){function c(b){f[b]=function(){var c=e.defer();try{var f=d(arguments);f.push(e.nresolver(c)),a[b].apply(a,f)}catch(g){c.reject(g)}return c.promise}}for(var f={instance:a},g=0;g<b.length;g++)c(b[g]);return f},e.ninvoke=e.ninvoke||function(a,b){var c=d(arguments,2),f=e.defer();c.push(e.nresolver(f));try{a[b].apply(a,c)}catch(g){f.reject(g)}return f.promise},e.nfapply=f.nfapply||function(a,b){var c=e.defer(),f=d(b);f.push(e.nresolver(c));try{a.apply(a,f)}catch(g){c.reject(g)}return c.promise},e.nfcall=f.nfcall||function(a){var b=d(arguments,1);return e.nfapply(a,b)},a.exports=e},function(b){b.exports=a},function(a){a.exports=b},function(a){a.exports=c}])});
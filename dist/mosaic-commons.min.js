/* 
 * mosaic-commons v0.0.15 | License: MIT 
 */
!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b(require("underscore"),require("when")):"function"==typeof define&&define.amd?define(["underscore","when"],b):"object"==typeof exports?exports["mosaic-commons"]=b(require("underscore"),require("when")):a["mosaic-commons"]=b(a.underscore,a.when)}(this,function(a,b){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){var d,e;d=[c,c(1),c(2),c(3),c(4)],e=function(){var b=a.exports={};return b.Class=c(1),b.Errors=c(2),b.Events=c(3),b.P=c(4),b}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(5)],e=function(){function a(a){a=a||{},b.extend(this.instanceFields,a.instanceFields),b.extend(this.classFields,a.classFields)}var b=c(5),d="__type",e="__meta",f="__type_id",g="__parent",h={instanceOf:function(a){var b=this.__getClass(),c=b.getMetaClass();return c.classFields.isSubtype.call(b,a,!0)},setOptions:function(a){this.options=b.extend({},this.options,a)},toString:function(){var a=this.__getClass();return a?a[f]+"":"undefined"},getClass:function(){return this.__getClass()},__getClass:function(){return this[d]}},i={isSubtype:function(a,b){if(!a||!a[f])return!1;for(var c=!1,d=b?this:this[g];!c&&d&&void 0!==d[f];d=d[g])c=d[f]==a[f];return c},isSameType:function(a){return a&&a[f]?this[f]==a[f]:!1},hasInstance:function(a){return a&&a.instanceOf?a.instanceOf.call(a,this):!1},getMetaClass:function(){return this[e]},getParent:function(){return this[g]},extend:function(){var a=this.getMetaClass(),c=a.createClass(this,b.toArray(arguments));return c}};b.extend(a.prototype,{instanceFields:h,classFields:i,extendClassFields:function(a,c){b.extend(c,this.classFields),b.extend(c,a),c[e]=this,c[f]=b.uniqueId("type-"),c[g]=a},extendInstanceFields:function(a,c){var e=a[g];b.extend(a.prototype,this.instanceFields),e&&b.each(b.keys(e.prototype),function(b){a.prototype[b]=e.prototype[b]}),b.each(c,function(c){b.extend(a.prototype,c)}),a.prototype[d]=a},newType:function(){function a(){this.initialize&&this.initialize.apply(this,arguments)}return a},createClass:function(a,b){var c=this.newType(a,b);return this.extendClassFields(a,c,b),this.extendInstanceFields(c,b),c}});var j=new a,k=j.createClass();return k.MetaClass=a,k}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(5)],e=function(){function a(){var b=a.newError;return b.apply(b,arguments)}function b(a){var b;return a instanceof Error?b=a:(g.isString(a)&&0===a.indexOf("Error: ")&&(a=a.substring("Error: ".length)),b=new Error(a)),g.extend(b,h),b}function d(a){var c=b(a.message);return g.isArray(a.trace)&&(c.stack=a.trace.join("\n")),a.code&&c.code(a.code),a.messageKey&&c.messageKey(a.messageKey),c}function e(a){var b={message:"ERROR"};return a&&(b.message=a+"",b.messageKey=a._messageKey,b.status=a.status||500,g.isArray(a.stack)?b.trace=f(a.stack):g.isString(a.stack)?b.trace=a.stack.split(/[\r\n]+/gim):g.isObject(a)?g.each(g.keys(a),function(c){b[c]=a[c]}):b.trace=[JSON.stringify(a)]),b}function f(a){return a?JSON.parse(JSON.stringify(a)):null}var g=c(5);g.extend(a,{newError:b,toJSON:e,fromJSON:d});var h={code:function(a){return void 0===a?this.status:(this.status=a,this)},messageKey:function(a){return void 0===a?this._messageKey:(this._messageKey=a,this)}};return a}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(5)],e=function(){var a=c(5),b={on:function(a,b,c){var d=this.__listeners=this.__listeners||{};c=c||this;var e=d[a]=d[a]||[];e.push({handler:b,context:c})},off:function(b,c,d){var e=this.__listeners;if(e){var f=e[b];f&&(f=a.filter(f,function(a){var b=a.handler===c;return b&=!d||a.context===d,!b}),e[b]=f.length?f:void 0)}},fire:function(b){var c=this.__listeners;if(c){var d=c[b];if(d){var e=a.toArray(arguments);e.splice(0,1),a.each(d,function(a){a.handler.apply(a.context,e)})}}}};b.addListener=b.on,b.removeListener=b.off,b.emit=b.fire;var d=function(){};return a.extend(d.prototype,b),a.extend(d,{EventsMixin:b,listenTo:function(a,b,c,d){var e=this._listeners=this._listeners||[];d=d||this,a.on(b,c,d),e.push({obj:a,event:b,handler:c,context:d})},stopListening:function(b,c){b?this._listeners=a.filter(this._listeners,function(a){var d=!0,e=a.context||this;return a.obj==b&&(c&&c!=a.event||(a.obj.off(a.event,a.handler,e),d=!1)),d},this):(a.each(this._listeners,function(a){var b=a.context||this;a.obj.off(a.event,a.handler,b)},this),delete this._listeners)},triggerMethod:function(){function b(a,b,c){return c.toUpperCase()}var c=/(^|:)(\w)/gi,d=function(d){var e="on"+d.replace(c,b),f=this[e];return a.isFunction(this.fire)&&this.fire.apply(this,arguments),a.isFunction(f)?f.apply(this,a.tail(arguments)):void 0};return d}()}),d}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c,c(6)],e=function(){function a(a,b){return Array.prototype.slice.call(a,b)}function b(){return d.apply(this,arguments)}for(var d=c(6),e=["promise","resolve","reject","defer","join","all","spread"],f=0;f<e.length;f++)b[e[f]]=d[e[f]];return b.promise=d.promise||function(){return new b},b.then=d.then||function(){var a=new b;return a.then.apply(a,arguments)},b.fin=function(a,c){return a.then(function(a){return b.then(function(){return c(null,a)}).then(function(){return a})},function(a){return b.then(function(){return c(a)}).then(function(){throw a})})},b.timeout=d.timeout?d.timeout:function(a,c){var d=b.defer(),e=setTimeout(function(){c=c||"Timed out after "+a+" ms",d.reject(new Error(c))},a);return d.promise.then(function(a){return clearTimeout(e),a},function(a){throw clearTimeout(e),a})},b.delay=d.delay||function(a){return a=a||0,b.then(function(c){var d=b.defer(),e=setTimeout(function(){d.resolve(c)},a);return d.promise.cancel=function(){clearTimeout(e),d.resolve(c)},d.promise})},b.nresolver=function(b){return function(c,d){c?b.reject(c):b.resolve(arguments.length>2?a(arguments,1):d)}},b.nwrapper=function(c,d){function e(d){f[d]=function(){var e=b.defer();try{var f=a(arguments);f.push(b.nresolver(e)),c[d].apply(c,f)}catch(g){e.reject(g)}return e.promise}}for(var f={instance:c},g=0;g<d.length;g++)e(d[g]);return f},b.ninvoke=b.ninvoke||function(c,d){var e=a(arguments,2),f=b.defer();e.push(b.nresolver(f));try{var g="function"==typeof d?d:c[d];g.apply(c,e)}catch(h){f.reject(h)}return f.promise},b.nfapply=d.nfapply||function(c,d){var e=b.defer(),f=a(d);f.push(b.nresolver(e));try{c.apply(c,f)}catch(g){e.reject(g)}return e.promise},b.nfcall=d.nfcall||function(c){var d=a(arguments,1);return b.nfapply(c,d)},b}.apply(null,d),!(void 0!==e&&(a.exports=e))},function(b){b.exports=a},function(a){a.exports=b}])});